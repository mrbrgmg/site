<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Définitions — minimal</title>
  <style>
    :root{--bg:#071024;--card:#0b1220;--accent:#60a5fa;--muted:#94a3b8}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; min-height:100vh; background:linear-gradient(180deg,#071024 0%, #0b1220 100%); color:#e6eef8; display:flex; align-items:center; justify-content:center; padding:20px}
    .card{width:100%; max-width:720px; background:var(--card); border-radius:12px; padding:22px; box-shadow:0 6px 24px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03)}
    h1{margin:0 0 8px 0; font-size:18px}
    .word{font-weight:700; font-size:36px; margin:12px 0}
    .definition{background:rgba(255,255,255,0.03); padding:14px; border-radius:10px; min-height:72px; display:none; white-space:pre-wrap}
    .definition.visible{display:block}
    .controls{display:flex; gap:10px; margin-top:12px}
    button{background:transparent; border:1px solid rgba(255,255,255,0.06); padding:10px 14px; color:inherit; border-radius:10px; cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),#3b82f6); border:0; color:#04263a}
    textarea{width:100%; min-height:120px; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit; margin-top:12px; resize:vertical}
    a.linked-word:hover{opacity:0.8;}
  </style>
</head>
<body>
  <main class="card">
    <h1>Définitions — minimal</h1>
    <div id="word" class="word">Mot</div>
    <div id="definition" class="definition" aria-hidden="true"></div>

    <div class="controls">
      <button id="prevBtn">Définition précédente</button>
      <button id="revealBtn" class="primary">Afficher la définition</button>
      <button id="nextBtn">Définition suivante</button>
    </div>

    <textarea id="edit" placeholder="Écris ta définition ici..."></textarea>
  </main>

  <script>
    let definitions = [];
    let currentIndex = 0;
    let history = [];
    let historyPointer = -1;

    const el = {
      word: document.getElementById('word'),
      def: document.getElementById('definition'),
      revealBtn: document.getElementById('revealBtn'),
      prevBtn: document.getElementById('prevBtn'),
      nextBtn: document.getElementById('nextBtn'),
      edit: document.getElementById('edit')
    };

    let wordMap = {};

    // Charger les définitions depuis le fichier JSON
    fetch("definitions.json")
      .then(response => response.json())
      .then(data => {
        definitions = data;
        wordMap = {};
        definitions.forEach(item => {
          const key = item.word.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
          wordMap[key] = item;
        });
        init(); // démarrer seulement après chargement
      });

    function pickRandom(exclude){ 
      if(definitions.length<=1) return 0; 
      let i; 
      do { i = Math.floor(Math.random()*definitions.length); } while(i===exclude); 
      return i; 
    }

    function linkifyDefinition(text){
      return text.split(/\s+/).map(token => {
        const match = token.match(/^(\W*)([\wÀ-ÖØ-öø-ÿ'-]+)(\W*)$/u);
        if(match){
          const prefix = match[1], word = match[2], suffix = match[3];
          const key = word.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
          if(wordMap[key]){
            return `${prefix}<a href="#" class="linked-word" data-key="${key}" style="color:#60a5fa; text-decoration:underline; cursor:pointer;">${word}</a>${suffix}`;
          }
        }
        return token;
      }).join(' ');
    }

    function renderFromHistory(){
      const state = history[historyPointer];
      if(!state) return;
      currentIndex = state.index;
      el.word.textContent = definitions[currentIndex].word;
      el.def.innerHTML = linkifyDefinition(definitions[currentIndex].definition || '(pas de définition)');
      el.def.classList.remove('visible');
      el.def.setAttribute('aria-hidden','true');
      el.revealBtn.textContent = 'Afficher la définition';
      el.edit.value = state.text || '';

      el.def.querySelectorAll('.linked-word').forEach(a => {
        a.addEventListener('click', e => {
          e.preventDefault();
          const key = a.dataset.key;
          const target = wordMap[key];
          if(target){
            saveCurrentState();
            currentIndex = definitions.indexOf(target);
            addToHistory(currentIndex, '');
            renderFromHistory();
          }
        });
      });
    }

    function saveCurrentState(){
      if(historyPointer>=0){
        history[historyPointer].text = el.edit.value;
      }
    }

    function addToHistory(index, text=''){
      history = history.slice(0, historyPointer+1);
      history.push({index, text});
      historyPointer = history.length - 1;
    }

    function toggleReveal(){ 
      const visible = el.def.classList.toggle('visible'); 
      el.def.setAttribute('aria-hidden', String(!visible)); 
      el.revealBtn.textContent = visible ? 'Masquer la définition' : 'Afficher la définition'; 
    }

    function prev(){
      if(historyPointer>0){
        saveCurrentState();
        historyPointer--;
        renderFromHistory();
      }
    }

    function next(){
      if(historyPointer<history.length-1){
        historyPointer++;
        renderFromHistory();
      } else {
        saveCurrentState();
        const newIndex = pickRandom(currentIndex);
        addToHistory(newIndex);
        renderFromHistory();
      }
    }

    function init(){ 
      const startIndex = Math.floor(Math.random()*definitions.length);
      addToHistory(startIndex, '');
      renderFromHistory();
    }

    el.revealBtn.addEventListener('click', toggleReveal);
    el.prevBtn.addEventListener('click', prev);
    el.nextBtn.addEventListener('click', next);

    document.addEventListener('keydown', (e)=>{
      const active = document.activeElement;
      const typing = active && (active.tagName==='INPUT' || active.tagName==='TEXTAREA');
      if(e.code === 'Space' && !typing){ e.preventDefault(); toggleReveal(); }
      if((e.key==='n' || e.key==='N') && !typing){ next(); }
      if((e.key==='p' || e.key==='P') && !typing){ prev(); }
    });
  </script>
</body>
</html>
